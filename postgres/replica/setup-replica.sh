#!/bin/bash
set -e

echo "=== SETTING UP POSTGRESQL REPLICA ==="

# ????, ???? ?????? ????? ?????
until pg_isready -h postgres-master -p 5432 -U admin -d mydb; do
  echo "Waiting for master..."
  sleep 2
done

echo "Master is ready, starting replication setup..."

# ????????????? PostgreSQL (???? ???????)
pg_ctl -D /var/lib/postgresql/data stop -m immediate || true

# ??????? ??? ??????
rm -rf /var/lib/postgresql/data/*

# ???????? ?????? ? ???????
echo "Starting base backup..."
PGPASSWORD=replica_password pg_basebackup \
  -h postgres-master \
  -p 5432 \
  -U replica_user \
  -D /var/lib/postgresql/data \
  -P -R -X stream

# ??????? standby ??????
touch /var/lib/postgresql/data/standby.signal

echo "=== REPLICA SETUP COMPLETE ==="

# ???? ????????? PostgreSQL
exec docker-entrypoint.sh postgres