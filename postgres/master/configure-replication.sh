#!/bin/bash
set -e

echo "=== CONFIGURING REPLICATION ACCESS ==="

# ???????? ?????????????? PostgreSQL
until pg_isready -U admin; do
  echo "Waiting for PostgreSQL to start..."
  sleep 2
done

# ???????? ???????????????????????????? ?????????? ?????? ?????????????? ??????????????
sleep 5

echo "Configuring pg_hba.conf for replication..."

# ?????????????????? ?????????????? ?? pg_hba.conf ?????? ????????????????????
cat >> /var/lib/postgresql/data/pg_hba.conf << EOF

# Replication connections
host replication replica_user 0.0.0.0/0 md5
host all all 0.0.0.0/0 md5
EOF

echo "Reloading PostgreSQL configuration..."
psql -U admin -d mydb -c "SELECT pg_reload_conf();"

echo "Checking configuration..."
psql -U admin -d mydb -c "SELECT name, setting FROM pg_settings WHERE name IN ('wal_level', 'max_wal_senders', 'max_replication_slots');"

echo "=== REPLICATION ACCESS CONFIGURED ==="